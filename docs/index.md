
### 名词约定

+ 终端：指各类智能物联网设备，通过物联网卡实现上网通讯
+ 后台：统称为提供终端接入服务的系统软件


### 通信方式

+ IoT设备传送数据的频率较高，业务数据量大的特点。TG-IoT协议采用`MQTT`来约定终端与后台服务的处理过程。
+ 终端ID 统一采用：终端IMEI+物联网卡ICCID来标识。
+ 终端首次开机通电、网络连接的情况下，将主动向后台发起`设备自注册`请求，后台处理请求，负责完成对终端注册、验证的判断，后台返回注册状态。
+ 终端通电、网络连接的过程中，主动按照间隔向后发起`位置、资料、参数`等上传信息。


### 网络结构

[结构示意图](https://www.processon.com/view/link/57fbb6b1e4b0f9a5558f7689)

### 协议格式说明

主题应该区分为：下行主题(即主题中要带有设备ID)，上行主题(主题中要带有命令字来区分，以便后台的业务逻辑来处理)

+ 终端与后台之间，通过采用`订阅与发布主题`的方式进行数据上报与指令的响应；
+ 中心下行指令订阅主题：


 主题名 | 存储属性 | 回复属性 |,| 功能类型编码 | 功能项关键字 |,| 指令数据 |
 ------ | ----- | ------ | ----- | ------ | ------ | ----- | ---- |


 * 主题名：iot/tg/v3/终端ID/
 * 存储属性：指明终端断电后该指令是否保存(只对部分设置参数有效),0表示不需要保存,1表示需要存储
 * 回复属性：指明终端收到指令后是否需要回复确认(只对部分指令有效),0表示不需要回复,1表示需要回复 
+ 终端上行指令发布主题：

 主题名 | 终端ID | , |回复属性 |,| 功能类型编码 | 功能项关键字 |,| 指令数据 |
 ----- | ------- | ----- | ------ | ------ | ----- | ---- | ---- | ---- |

  * 主题名：iot/tg/v3/
  * 回复属性：指明中心收到本指令后是否需要确认回复,0表示不需要回复,1表示需要回复
  
注：

1. 中心下行指令下发时，需要知道接收下行指令的终端ID，因此每台终端首次开机都会主动订阅与自己ID相关的主题。举例：如某台终端的ID为1234554321，其开机通电后，会在后台订阅一份主题名为：iot/tg/v3/1234554321。后台如果需要对该终端进行指令下行，则可以发布主题为：iot/tg/v3/1234554321/01,AB,1234,3221的内容；
2. 本协议提到字母、符号一律为半角；


## 协议消息体详细说明

#### 中心下发指令

##### 设置类指令(功能类型编码：A)

###### 设置服务器IP地址、端口号
1. 功能项关键字：P
2. 指令数据：P1,P2
3. 参数说明：
  + P1：IP地址
  + P2：Port端口号
4. 举例：iot/tg/v3/设备ID/11,AP,112.34.21.22,1233

###### 设置终端时钟参数
1. 功能项关键字：Q
2. 指令数据：P1
3. 参数说明：
  + P1：时间戳
4. 举例：iot/tg/v3/设备ID/11,AQ,113434344


###### 设置电子狗参数

1. 功能性关键字：D
2. 指令数据：P1,P2
3. 参数说明：
  + P1：参数名 A-语音播报模式 B-雷达预警模式 C-云播报 D-流动静音 E-亮度 F-音量 G-震动灵敏度
  + P2：参数值 根据不同的参数名其值代表的意义不同
4. 举例：iot/tg/v3/设备ID/01,AD,A,0


##### 控制类指令(功能类型编码：B)

###### 读取终端参数

1. 功能项关键字：A
2. 指令数据：无
3. 参数说明：无
4. 举例：iot/tg/v3/设备ID/01,BA

###### 远程拍照

1. 功能项关键字：C
2. 指令数据：P1,P2,P3
3. 参数说明：
  + P1：图像质量 0-低 1-中 2-高
  + P2：摄像头通道 0-前置 1-后置 2-前后置
  + P2：连续抓拍图像张数,缺省：1张
  + P3：抓拍间隔,单位：秒
4. 举例：iot/tg/v3/设备ID/00,BC,1,0,1,0


###### 远程录制视频

1. 功能项关键字：D
2. 指令数据：P1
3. 参数说明：
  + P1：视频质量 0-低 1-中 2-高
  + P2：拍摄时长，单位：秒
4. 举例：iot/tg/v3/设备ID/00,BD,1,30

###### 远程导航信息

1. 功能项关键字：N
2. 指令数据：P1,P2,P3
3. 参数说明：
  + P1：经度,WGS-84坐标
  + P2：纬度,WGS-84坐标
  + P3：地址描述
4. 举例：iot/tg/v3/设备ID/00,BN,112.32423,23.24134,北京王府井大待123号




##### 增值服务类/响应类指令(功能类型编码：I)		


###### 下发资源上传授权凭证

该下行指令是与`终端上行指令：获取资源上传token`相对应

1. 功能性关键字：A
2. 指令数据：P1,P2
3. 参数说明：
  * P1：资源上传token
  * P2：资源上传的buckname(一般第三方云存储空间,在上传资源的时候,需要指定token、buckname)
4. 举例：iot/tg/v3/123456789/01,IA,11111111111,tgimg

###### 下发天气信息

该下行指令是与`终端上行指令：获取天气`相对应。

1. 功能项关键字：B
2. 指令数据：P1,P2,P3,P4
3. 参数说明：
  + P1：城市名称，如「深圳」
  + P2：日期，如「2016-10-10」
  + P3：温度，如「-28或32」
  + P4：天气描述，如「晴转多云」

4. 举例：iot/tg/v3/设备ID/00,IA,深圳,2016-10-10,27,晴转多云

###### 下发实时路况信息

该下行指令是与`终端上行指令：获取实时路况`相对应。

1. 功能项关键字：C
2. 指令数据：P1,P2
3. 参数说明：
  * P1：路况标记 0-前方路况 1-周边路况
  * P2：路况信息描述

4. 举例：iot/tg/v3/设备ID/00,IC,0,前方300米道路拥堵请避开行驶

###### 下发设备自注册状态

该下行指令是与`终端上行指令：设备自注册`相对应

1. 功能项关键字：R
2. 指令数据：P1
3. 参数说明：
  * P1：注册状态 0-成功,1-失败
4. 举例： iot/tg/v3/设备ID/00,IR,0

-----


#### 终端上传指令

##### 上传状态类信息(功能类型编码为A)

###### 终端自注册

终端首次开机通电使用时，主动通过域名或IP方式向后台发起`终端自注册`行为，后台根据自注册信息，判断是否合法、有效，并返回对应的参数信息；

终端发现当前的ICCID的信息变化时，应再次发起`终端自注册`过程，以便通知后台更新ICCID；


1. 功能项关键字：R
2. 指令数据：P1,P2,P3
3. 参数说明：
  * P1：流量卡ICCID
  * P2：客户ID
  * P3：固件版本号
4. 举例： iot/tg/v3/12345678,0,AR,400000133434,4001,3.0.0.2


###### 终端登录/退出

终端开机通电后，在已经完成终端自注册的情况下，应主动与后台发起`终端登录`，用于提醒后台终端上线；

终端正常关机退出时，应主动向后台发起`终端退出`请求，用于提醒后台该终端已下线；

1. 功能性关键字：L
2. 指令数据：P1
3. 参数说明：
  * P1：0-登录，1-退出
4. 举例：iot/tg/v3/12345678,0,AL,0

###### 终端参数上传

上报当前终端设置的所有参数；

1. 功能项关键字：A
2. 指令数据：P1,P2,P3,P4,P5,P6,P7
3. 参数说明：
  * P1：语音播报模式值
  * P2：雷达预警模式值
  * P3：云播报值
  * P4：流动静音值
  * P5：亮度值
  * P6：音量值
  * P7：震动灵敏度值
4. 举例：iot/tg/v3/设备ID,0,P1,P2,P3,P4,P5,P6,P7


##### 上传定位类信息(功能类型编码为B)


###### 位置上报

终端在开机工作状态下，按照规定的间隔时间上报位置及车辆状态信息；

1. 功能性关键字：A
2. 指令数据：P1,P2,P3,P4,P5,P6,P7,P8,P9
3. 参数说明：
  * P1：GPS定位时间，格式：yyyyMMddhhmmss
  * P2：经度,WGS-84坐标系(?用整数还是浮点数表示，比较合适呢）
  * P3：纬度,WGS-84坐标系
  * P4: 速度，单位是2节
  * P5：方向，正北是0度，顺时钟方向	
  * P6：GPS定位标记位 0-精确定位 1-非精确定位
  * P7：卫星颗数
  * P6：GSM信号强度
  * P8：累计里程
  * P9：点火状态 0-点火,1-熄火
  * P10：电瓶值
4. 举例：iot/tg/v3/12345678,0,BA,20161102143224,112.2343,32.2422,45,125,0,7,12,1123,0,12.5


###### 图片上传

1. 功能性关键字：P
2. 指令数据：P1,P2,P3,P4
3. 参数说明：
  * P1：GPS时间
  * P2：经度
  * P3：纬度
  * P4：速度
  * P5：方向
  * P6：摄像头类型 0-前置 1-后置 2-前后置
  * P7：图片类型 0-抓拍 1-震动报警拍 2-SOS报警拍
  * P6：图片云空间URL，需要进行URLEncod编码
4. 举例：iot/tg/v3/123456789,0,BP,20161108123221,112.2343,32.2422,45,125,1,2,图片URL


##### 视频上传

1. 功能性关键字：V
2. 指令数据：P1,P2,P3,P4
3. 参数说明：
  * P1：GPS时间
  * P2：经度
  * P3：纬度
  * P4：速度
  * P5：方向
  * P6：摄像头类型 0-前置 1-后置 2-前后置
  * P7：视频类型 0-抓拍 1-震动报警拍 2-SOS报警拍
  * P6：视频云空间URL，需要进行URLEncod编码
4. 举例：iot/tg/v3/123456789,0,BV,20161108123221,112.2343,32.2422,45,125,0,0,图片URL


##### 增值服务请求类信息(功能类型编码：I)


###### 获取资源上传凭证

终端需要上传资源(图片/视频)时，需要向后台发起请求，获取资源上传授权凭证后，方可进行资源上传。

1. 功能性关键字：A
2. 指令数据：无
3. 参数说明：无
4. 举例：iot/tg/v3/123456789,0,IA

###### 获取天气信息

终端向后台请求当前位置的天气信息。

1. 功能性关键字：B
2. 指令数据：P1,P2,P3
3. 参数说明：
  * P1：经度,WGS-84坐标
  * P2：纬度,WGS-84坐标
  * P3：GPS时间,格式:yyyyMMddhhmmss
4. 举例：iot/tg/v3/123456789,0,IB,112.23432,32.242,20161108123422


###### 获取实时路况

终端向后台请求当前位置前方、周边的实时路况信息

1. 功能性关键字：C
2. 指令数据：P1,P2,P3
3. 参数说明：
  * P1：经度,WGS-84坐标
  * P2：纬度,WGS-84坐标
  * P3：GPS时间,格式:yyyyMMddhhmmss
  * P4：路况标记 0-前方路况 1-周边路况(范围:200米)
3. 参数说明：
4. 举例：iot/tg/v3/123456789,0,IC,112.23432,32.242,20161108093245,0



