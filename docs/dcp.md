
## 智能车载设备通讯规约「Device Communication Protocol,DCP」

### 名词约定

+ 设备：指各类能够联网的物联网设备(如：智能后视镜、大屏机、行车记录仪等)，这些设备通过「物联网卡」实现网络通讯，因此需要约定设备与后台之间的通讯协议；
+ 平台：指为设备接入提供各项服务的软件总称(如：设备接入网关、业务处理网关、中间件服务层);
+ 设备ID: 每台设备都有一个唯一标识码(如：设备IMEI )，通过这个设备ID 作为在系统中唯一标识；
+ MQTT：https://github.com/mcxiaoke/mqtt ; 
+ 消息：是指设备与后台之间的传输的具体规约内容(必须是JSON格式); 

#### 通讯约定

+ 设备与后台之间采用`标准、开源的MQTT`，采取订阅与发布，作为彼此的通讯约定；
+ 设备首次开机通电、网络连接的情况下，将主动向后台发起`设备自注册`请求，后台处理此请求，并返回相关配置信息(如：设备ID、设备名称、设备密钥、联接域名和端口);
+ 设备通电、网络正常的情况下，会按照约定上传相关数据或响应后台的下行指令，因此设备与后台之间的通讯过程是双向；
+ 设备上行指令，是通过订阅topic，如： /productid/deviceid/update 进行发布；
+ 后台对设备的下行指令，是通过订阅topic，如： /productid/deviceid/get 进行发布；
+ topic中消息内容必须是`JSON`格式，消息内容结构是由：消息版本号(即通讯规约版本号)+消息头对象+消息体对象，消息内容结构如下：

```json
{
  "version":1,             //协议版本号
  "msg_head":{             
    "msg_id":0x0001,       //命令字
    "deviceid":"32位长度",   //设备标识
    "msg_seq":1112343        //消息流水号,由消息发起方维护，从1开始，至0xFFFF结束，重新从1开始；
    },
  "msg_body":{
    //不同的命令字，其对应的消息体会有所不同。此处不再展开，请详细参考后面各个命令字-消息体的约定；

    },
    “timestamp”:"时间戳"
}

```


### 规约分类
+ 设备管理类
 + 设备注册/注销
 + 设备鉴权
 + 设置/查询设备参数
 + 设备控制 
+ 位置、报警类
 + 位置信息上报
 + 位置信息查询
 + 设备报警
+ 信息下发类
 + 文本信息下发
+ 多媒体类
 + 多媒体数据上传
 + 摄像头立即拍摄
+ 增值服务类
 + 天气
 + 路况
 + 电子眼
 

### 消息格式

#### 设备通用应答
> 消息ID:0x0001
> 设备通用应答消息体数据格式如下：
```json
"res_seq_id":"对应的平台消息流水号",
"res_msg_id":"对应的平台消息ID",
"res_result":0|1|2|3,   //0:成功/确认;1:失败;2:消息有误;3:不支持
```

#### 平台通用应答
> 消息ID:0x8001
> 平台通用应答消息体数据格式如下：
```json
"res_seq_id":"对应的设备消息流水号",
"res_msg_id":"对应的设备消息ID",
"res_result":0|1|2|3,   //0:成功/确认;1:失败;2:消息有误;3:不支持
```

#### 位置信息上报

> 消息ID:0x0200
> 位置信息上报的消息体是由``位置基本信息``和``位置附加信息``两项组成，其中``位置附加信息``是由各位置附加信息项组合，也可没有。
> 位置基本信息数据格式如下：
```json
"pos_base":{
  "alarm_flag":0, //报警标志位定义
  "status":0, //设备状态位定义
  "lat":112.32434,//以度为单位的纬度值乘以10的6次方，精确到百万分之一度
  "lon":32.23434, //以度为单位的经度值乘以10的6次方，精确到百万分之一度
  "altitude":234, //海拨高度,单位为米(m)
  "speed":128, //速度,单位百公里/h
  "direct":328,//方向,0-359，正北为0，顺时针
  "gpstime":134343434,//GPS时间戳
}
```

