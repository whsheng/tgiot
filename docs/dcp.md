
## 智能车载设备通讯规约「Device Communication Protocol,DCP」

### 名词约定

+ 设备：指各类能够联网的物联网设备(如：智能后视镜、大屏机、行车记录仪等)，这些设备通过「物联网卡」实现网络通讯，因此需要约定设备与后台之间的通讯协议；
+ 平台：指为设备接入提供各项服务的软件总称(如：设备接入网关、业务处理网关、中间件服务层);
+ 设备ID: 每台设备都有一个唯一标识码(如：设备IMEI )，通过这个设备ID 作为在系统中唯一标识；
+ MQTT：https://github.com/mcxiaoke/mqtt ; 
+ 消息：是指设备与后台之间的传输的具体规约内容(必须是JSON格式); 

#### 通讯约定

+ 设备与后台之间采用`标准、开源的MQTT`，采取订阅与发布，作为彼此的通讯约定；
+ 设备首次开机通电、网络连接的情况下，主动向平台发起API请求，获取设备配置参数
+ 设备首次开机通电、网络连接的情况下，将主动向后台发起`设备自注册`请求，后台处理此请求，并返回相关配置信息(如：设备ID、设备名称、设备密钥、联接域名和端口);
+ 设备通电、网络正常的情况下，会按照约定上传相关数据或响应后台的下行指令，因此设备与后台之间的通讯过程是双向；
+ 设备上行指令，是通过订阅topic，如： /productid/deviceid/update 进行发布；
+ 后台对设备的下行指令，是通过订阅topic，如： /productid/deviceid/get 进行发布；
+ topic中消息内容必须是`JSON`格式，消息内容结构是由：消息版本号(即通讯规约版本号)+消息头对象+消息体对象，完整的消息内容结构如下：

```json
{
  "version":1,             //协议版本号
  "msg_head":{             
    "msg_id":0x0001,       //命令字
    "deviceid":"32位长度",   //设备标识
    "msg_seq":1112343        //消息流水号,由消息发起方维护，从1开始，至0xFFFF结束，重新从1开始；
    "msg_res":0 //是否要求通用应答，0-无须回应 1-必须回应
    },
  "msg_body":{
    //不同的命令字，其对应的消息体会有所不同。此处不再展开，请详细参考后面各个命令字-消息体的约定；

    },
   
  "timestamp":"时间戳"
}

```

+ 不管是平台还是设备收到的消息内容中，如果有msg_res=1，则表示要对该消息进行通用应答处理；
+ 多媒体资源文件命名规则 = deviceID_timestamp.扩展名
+ 本协议中各个消息中涉及到的命令字ID，为了描述方便，而在文中使用0x方式表达，但在实际消息内容中，该命令字应为10进制整数类型；

---


### 消息格式

---

#### 设备通用应答
+ 消息ID:0x0001

+ 设备通用应答消息体数据格式如下：

```json
"res_seq_id":"对应的平台消息流水号",
"res_msg_id":"对应的平台消息ID",
"res_result":0|1|2|3,   //0:成功/确认;1:失败;2:消息有误;3:不支持
```

#### 平台通用应答
+ 消息ID:0x8001
+ 平台通用应答消息体数据格式如下：

```json
"res_seq_id":"对应的设备消息流水号",
"res_msg_id":"对应的设备消息ID",
"res_result":0|1|2|3,   //0:成功/确认;1:失败;2:消息有误;3:不支持
```

#### 位置信息上报

+ 消息ID:0x0201

+ 位置信息上报的消息体是由``位置基本信息``和``位置附加信息``两项组成，其中``位置附加信息``是由各位置附加信息项组合，也可没有。

+ 位置基本信息数据格式如下：
+ 
```json
"pos_base":{
  "alarm_flag":0, //报警标志位定义，见表1
  "status":0, //设备状态位定义，见表2
  "lat":112.32434,//以度为单位的纬度值乘以10的6次方，精确到百万分之一度
  "lon":32.23434, //以度为单位的经度值乘以10的6次方，精确到百万分之一度
  "altitude":234, //海拨高度,单位为米(m)
  "speed":128, //速度,单位百公里/h
  "direct":328,//方向,0-359，正北为0，顺时针
  "gpstime":134343434,//GPS时间戳
  "satelite":4,  //卫星颗数
  "gsm":24,  //GSM信号强度
  "battery":32.8  //电瓶电压值
}
```

表1_报警标志位定义

位 | 定义 | 处理说明 
---- | ---- | ------
0 | 1：紧急报警 | |
1 | 1：超速报警 |  |
2 | 1：疲劳报警 | |
3 | 1：危险驾驶 | |
4 | 1：碰撞预警 ||
5 | 1：侧翻预警 | |
6-31 | 保留 | |

表2_状态位定义

位 | 状态
---- | ---- |
0 | 0： ACC 关  1：ACC 开|
1 | 0：未定位 1：定位 |
2 | 0：北纬 1：南纬 |
3 | 0：东经 1：西经 |
4 - 31 | 保留 |


#### 位置信息查询

+ 消息ID : 0x8201
+ 平台查询指定设备的位置信息，消息体为空，格式如下：

```json
{
  "version":1,             
  "msg_head":{             
    "msg_id":0x8201,       
    "deviceid":"32位长度",   
    "msg_seq":1112343,
    "msg_res":1     
    },
  "msg_body":null,
  "timestamp":"时间戳",

}
```

#### 设置终端参数

+ 消息ID ：0x8103
+ 设置终端参数消息数据格式如下,具体各参数项见下表3

```json
"params":{
   "0xF001": 0,
   "0xF002": 2,
	  //......
}

```
+ msg_res 必须为1

表3_设备参数项

参数项 | 参数描述 | 参数取值
---- | ---- | ----- |
0xF001 | 语音播报模式 | 0-标准模式 1-简洁模式 2-静默模式 |
0xF002 | 雷达预警模式 | 0-自动 1-郊区 2-市区 3-静默 |
0xF003 | 云播报-路况设置 | 0-开 1-关 |
0xF004 | 云播报-天气设置 | 0-开 1-关 |
0xF005 | 云播报-事件设置 | 0-开 1-关 |
0xF006 | 流动静音 | 0-关 20～60 |
0xF007 | 亮度设置 | 0-关 1～10 |
0xF008 | 音量设置 | 0-关 1~6 |
0xF009 | 震动灵敏度 | 0-关 1-低 2-中 3-高 |

 

#### 查询终端参数

+ 消息ID ：0x8104
+ 查询终端参数消息体为空，消息格式如下：

```json
{
  "version":1,             
  "msg_head":{             
    "msg_id":0x8104,       
    "deviceid":"32位长度",   
    "msg_seq":1112343     
    },
  "msg_body":null,
  "timestamp":"时间戳"
}

```

#### 查询终端参数设置应答

+ 消息ID : 0x0104
+ 查询终端参数应答，终端回应的消息体数据格式如下(全部参数值)：

```json
	"params":{
	  "0xF001":1
	  "0xF002":0,
	  //......
	}
```

#### 远程拍照控制

+ 消息ID ：0x8205
+ 控制设备远程拍照，消息体数据格式如下：

```json
 "quality":0,   //图像质量 0-低 1-中 2-高
 "channel":0,   //摄像头通道开启约定，见表4
 "photos":1,    //每个摄像头抓拍图像张数(保留)
 "interval":10   //每个摄像头抓拍间隔，单位：秒

```


#### 远程拍照响应

+ 消息ID：0x0205
+ 设备响应平台下发的远程拍照命令，消息体格式如下：

```json
"res_seq_id":"响应平台消息流水",
"filename":"照片文件名",
"buckname":"云存储空间名",
"channel":0,  //哪个摄像头通道产生,见表4
"model":0 //0-远程控制 1-震动 2-SOS报警
```

#### 远程录像控制

+ 消息ID ：0x8206
+ 控制设备远程录像，消息体数据格式如下：

```json
 "quality":0,   //视频质量 0-低 1-中 2-高
 "channel":0,   //摄像头通道开启约定，见表4
 "times":10   //每个摄像头录制时长，单位：秒

```

#### 远程录像响应

+ 消息ID：0x0206
+ 设备响应平台下发的远程录像命令，消息体格式如下：

```json
"res_seq_id":"对应所响应平台消息流水",
"filename":"视频文件名",
"buckname":"云存储空间名",
"channel":0,  //哪个摄像头通道产生,见表4
"model":0 //0-远程控制 1-震动 2-SOS报警
 
```

表4_摄像头开启约定表

位 | 摄像头通道
---- | ---- 
0 | 前摄像头 
1 | 后摄像头
2 | 左摄像头
3 | 右摄像头
4 | 内置摄像
5-7 | 保留 


#### 查询天气信息

+ 消息ID：0x0501
+ 设备向后台查询指定经纬度的当天天气信息,消息体格式约定如下：

```json
"lng":112.34343,
"lat":23.23434,
```

#### 查询天气信息应答

+ 消息ID：0x8501
+ 后台应答指定经纬度的当天天气信息，消息体格式约定如下：

```json
 "lng":112.3434,
 "lat":32.34324,
 "city":"城市名称",
 "date":"2017-02-24",
 "weather_temp":"-28或32",
 "weather_desc":"天气信息描述,一般用于TTS播报"
```

#### 查询实时路况信息

+ 消息ID ：0x0502
+ 设备向后台查询指定经纬度附近的实时路况信息，消息体格式约定如下：

```json
 "lng":112.23434,
 "lat":32.3434,
 "road_condition":0 //参考表5

```


#### 查询实时路况信息应答

+ 消息ID：0x8502
+ 后台应答指定经纬度附近的实时路况信息，具体格式约定如下：

```json
"lng":112.23432,
"lat":32.2434,
"road_condition":0,
"road_desc":"路况信息描述，一般用于TTS播报"
```

表5_路况约定

路况类型 | 描述
---- | ----
0 | 周边路况
1 | 前方路况


#### 文本信息下发

+ 消息ID：0x8503
+ 后台向指定设备下发文本信息，设备根据内容自行进行播报，消息体格式如下：

```json
 "text":"utf-8编码格式"
```

#### 查询资源上传凭证

+ 消息ID：0x0601
+ 设备需要上传资源(图片/视频)时，需要向后台发起请求，获取资源上传授权凭证后，方可进行资源上传。消息体无。


#### 资源上传凭证响应

+ 消息ID：0x8601
+ 平台响应终端的资源上传凭证申请要求，消息体格式约定如下：

```json
"upload_token":"2343434343",
"buckname":"存储空间名称",
"upload_domain":"上传域名",
"upload_port":"上传端口"
```


----

### 规约分类
+ 设备管理类
 + 设备注册/注销 [二期实现]
 + 设备鉴权 [二期实现]
 + 设置/查询设备参数[一期实现]

+ 位置、报警类
 + 位置信息上报 [一期实现]
 + 位置信息查询 [一期实现]

+ 信息下发类
 + 文本信息下发 [一期实现]
 
+ 多媒体类
 + 多媒体数据上传 [一期实现]
 + 远程拍照、视频 [一期实现]
 
+ 增值服务类
 + 天气 [一期实现]
 + 路况 [一期实现]
 + 电子眼 [二期考虑]

### 实现约定

+ 测试卡管理：基于测试卡上来的设备信息，是不能被注册到平台中，并且设备端负责通知用户获知；
+ 设备端判断卡的变化，如果卡有变化，则主动向平台进行申请；
+ 整个平台是以设备的纬度进行管理；
+ 同时整个平台上面也是要以卡的维度来进行管理；
+ 设备的唯一标识码就是设备IMEI
 
 
